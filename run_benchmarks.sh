#!/bin/bash
# OxideDB Performance Benchmark Runner
# Usage: ./run_benchmarks.sh [options]
# Options:
#   --all         Run all benchmarks (default)
#   --insert      Run insert benchmarks only
#   --find        Run find/query benchmarks only
#   --aggregate   Run aggregation benchmarks only
#   --save        Save results to benchmark-results.json
#   --compare     Compare with previous results (if available)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RESULTS_DIR="$SCRIPT_DIR/benchmark-results"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
REPORT_FILE="$RESULTS_DIR/report-$TIMESTAMP.md"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if Postgres URL is set
if [ -z "$OXIDEDB_TEST_POSTGRES_URL" ]; then
    echo -e "${RED}Error: OXIDEDB_TEST_POSTGRES_URL environment variable not set${NC}"
    echo "Example: export OXIDEDB_TEST_POSTGRES_URL=postgres://postgres:postgres@localhost:5432/postgres"
    exit 1
fi

# Create results directory
mkdir -p "$RESULTS_DIR"

# Parse arguments
RUN_INSERT=false
RUN_FIND=false
RUN_AGGREGATE=false
SAVE_RESULTS=false
COMPARE=false

if [ $# -eq 0 ] || [ "$1" == "--all" ]; then
    RUN_INSERT=true
    RUN_FIND=true
    RUN_AGGREGATE=true
fi

for arg in "$@"; do
    case $arg in
        --insert)
            RUN_INSERT=true
            ;;
        --find)
            RUN_FIND=true
            ;;
        --aggregate)
            RUN_AGGREGATE=true
            ;;
        --save)
            SAVE_RESULTS=true
            ;;
        --compare)
            COMPARE=true
            ;;
    esac
done

echo "=========================================="
echo "OxideDB Performance Benchmark Suite"
echo "=========================================="
echo "Postgres URL: $OXIDEDB_TEST_POSTGRES_URL"
echo "Results Directory: $RESULTS_DIR"
echo ""

# Function to run a benchmark
run_benchmark() {
    local name=$1
    local bench_name=$2
    local output_file="$RESULTS_DIR/${name}-${TIMESTAMP}.json"
    
    echo -e "${YELLOW}Running $name benchmarks...${NC}"
    
    if [ "$SAVE_RESULTS" = true ]; then
        cargo bench --bench $bench_name -- --noplot --save-baseline "$TIMESTAMP" 2>&1 | tee "$output_file"
    else
        cargo bench --bench $bench_name -- --noplot 2>&1
    fi
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✓ $name benchmarks completed${NC}"
    else
        echo -e "${RED}✗ $name benchmarks failed${NC}"
        return 1
    fi
    echo ""
}

# Run benchmarks
if [ "$RUN_INSERT" = true ]; then
    run_benchmark "Insert" "insert_benchmark"
fi

if [ "$RUN_FIND" = true ]; then
    run_benchmark "Find" "find_benchmark"
fi

if [ "$RUN_AGGREGATE" = true ]; then
    run_benchmark "Aggregate" "aggregate_benchmark"
fi

# Generate report
echo "=========================================="
echo "Generating Report..."
echo "=========================================="

cat > "$REPORT_FILE" << EOF
# OxideDB Performance Benchmark Report

**Date:** $(date)
**Commit:** $(git rev-parse --short HEAD)
**Postgres URL:** $OXIDEDB_TEST_POSTGRES_URL

## Summary

This report contains performance benchmarks for OxideDB operations.

### Benchmarks Run

EOF

if [ "$RUN_INSERT" = true ]; then
    echo "- ✓ Insert Operations" >> "$REPORT_FILE"
fi
if [ "$RUN_FIND" = true ]; then
    echo "- ✓ Find/Query Operations" >> "$REPORT_FILE"
fi
if [ "$RUN_AGGREGATE" = true ]; then
    echo "- ✓ Aggregation Operations" >> "$REPORT_FILE"
fi

cat >> "$REPORT_FILE" << EOF

## Detailed Results

Results are stored in JSON format in the following files:

EOF

for file in "$RESULTS_DIR"/*-"$TIMESTAMP".json; do
    if [ -f "$file" ]; then
        echo "- $(basename $file)" >> "$REPORT_FILE"
    fi
done

cat >> "$REPORT_FILE" << EOF

## Running Benchmarks

To reproduce these results:

\`\`\`bash
export OXIDEDB_TEST_POSTGRES_URL="$OXIDEDB_TEST_POSTGRES_URL"
./run_benchmarks.sh --all --save
\`\`\`

## Individual Benchmarks

\`\`\`bash
# Insert operations only
./run_benchmarks.sh --insert

# Find operations only
./run_benchmarks.sh --find

# Aggregation operations only
./run_benchmarks.sh --aggregate
\`\`\`

---

*Generated by OxideDB Benchmark Suite*
EOF

echo -e "${GREEN}Report saved to: $REPORT_FILE${NC}"

# Show summary
echo ""
echo "=========================================="
echo "Benchmark Summary"
echo "=========================================="
echo "Results Directory: $RESULTS_DIR"
echo "Report File: $REPORT_FILE"
echo ""

if [ "$SAVE_RESULTS" = true ]; then
    echo -e "${GREEN}Results saved for comparison${NC}"
    echo "To compare with previous runs, use:"
    echo "  cargo bench -- --baseline $TIMESTAMP"
fi

echo ""
echo -e "${GREEN}All benchmarks completed!${NC}"
